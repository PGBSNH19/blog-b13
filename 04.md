##  **Övning 1: CI pipeline i Azure DevOps** 

**Bakgrund** 

En pipeline definieras som en tjänst som automatiserar processen att bygga och testa kod och göra dessa koder tillgängliga för andra människor. Microsoft erbjuder en sådan pipeline i sin molntjänst, som kallas "Azure pipelines".  Azure-pipeline följer två metoder; continuous integration (CI) och kontinuerlig leverans (CD). Continuous integration (CI) handlar om att automatisera processen att bygga och testa kod i ett repo när en ny förändring har gjorts.



**Skapa pipeline** 

Först behövde vi skapa vår eget API-projekt. Detta löste vi genom att använda ett exempelprojekt skapat av Microsoft (https://docs.microsoft.com/en-us/aspnet/core/tutorials/first-web-api?view=aspnetcore-3.1&tabs=visual-studio-code). Därefter behövde vi skapa vår Docker-fil vilket innehöll instruktioner hur image skulle skapas och köras. Instruktionerna var likt förra Docker-filen som vi använde under lektion 3. Enda instruktionen som behövde ändras var COPY eftersom vi hade Dockerfilen utanför API-projektet. Vi skapade även en enkel unit test för projektet. Efter detta var klart så skapade vi en ny repo i Github och pushade in alla filer.



Efter detta var klart så kunde vi skapa vår Azure pipeline. Vi navigerade till Azure Devops och skapade vår nya projekt "cloudassignment". Därefter skapade vi vår nya pipeline. Först behövde man ange vår kod fanns (detta fallet var det i GitHub), sen behövde vi välja vår repository (TestAPI), sen ange att vi ville bygga och pusha en Docker image till ACR, därefter anger vi image namn och ACR-detaljer. När detta var klart så presenterade Azure vår pipeline yaml-fil.



**Pipeline filen** 

Likt Docker-filen så innehåller Pipeline-filen instruktioner, men i detta fall handlar dessa instruktioner om hur CI/CD processen ska ske. Den mest noterbara delen i Pipeline-filen är de olika steg "stages". Dessa steg instruerar pipeline vilka uppgifter den ska göra genom, dessa uppgifter (task) kan till exempel vara att bygga en webbapplikation, eller även som vi har valt att göra, köra unit tester. I vår fall så skapade Azure fördefinierade steg och uppgifter  för Pipeline-filen vilken var att bygga och pusha image till vår ACR. Förutom att bygga och pusha vår image så behövde vi även kör vår unit test. Detta krävdes att vi behövde ändra Pipeline-filen vilket innehöll: uppgiften (task) vilket var att använda dotnetcore CLI, vilken kommando (command) vi ville köra samt var projektmappen låg för unit test (projects). Våra uppgifter, inkl. unit test, i Pipeline-filen såg således ut såhär:



![Vår pipeline fil](https://i.imgur.com/4dMQrcp.png)



Notera hur vi refererar till vår test-mapp, här använder vi en variabel som definierats i Pipeline-filen. Denna variabel $(testfilePath) definierade vi själva. Azure skapade andra fördefinerade variablar som till exempel imageRepository (namn på vår image), containerRegistry (vår ACR) och dockerfilePath (var vår Docker-fil är placerad).



![Variablar](https://i.imgur.com/ei8AVJW.png)



Andra viktiga delar i Pipeline-filen är "resources" och "trigger". I vår fall så handlar resource om vilken repository vår yaml-fil befinner sig i. Trigger handlar om att definiera vilka brancher som sätter igång en CI. Till exempel, om jag specifierar master som trigger så kommer pipeline köras varje gång någon commitar till master-branschen. Azure har redan definierat att commits till master-branschen (i vår repo) "triggar" en bygg. Om vi inte skulle specifiera en trigger så skulle en CI köras varje gång en person commitar till vilken bransch som helst i repot. 



![Trigger och resources](https://i.imgur.com/Y2IBiS3.png)



Efter Pipeline-filen var färdigredigerat så kunde vi skapa vår pipeline. Vi klickade på "Save and Run" vilket skapade ny Pipeline-fil och pushade upp det till vår repository (https://github.com/NorShiervani/TestAPI/). Azure körde därefter vår pipeline, allt lyckades! Pipeline körde även vår Unit test vilket också lyckades.



![Unit test](https://i.imgur.com/aJVPHDs.png)

[![Build Status](https://dev.azure.com/norshiervani0999/cloudassignment/_apis/build/status/NorShiervani.TestAPI?branchName=master)](https://dev.azure.com/norshiervani0999/cloudassignment/_build/latest?definitionId=6&branchName=master)



##  **Övning 2: CD pipeline i Azure DevOps** 

**Docker image som en del av CI bygg** 

-

**Release pipeline** 

-